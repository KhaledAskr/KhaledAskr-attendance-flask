{% extends "layout.html" %}
{% block title %}مسح كود QR{% endblock %}
{% block content %}
<div class="text-center">
  <h3>📷 مسح كود QR</h3>
  <div id="reader" style="width:320px; margin:auto; border-radius:10px;"></div>

  <form id="scanForm" method="POST" action="{{ url_for('mark_attendance') }}">
    <input type="hidden" name="student_id" id="student_id">
    <input type="hidden" name="session_num" value="1">
  </form>

  <div id="status" class="mt-3 text-success fw-bold"></div>
</div>

<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script>
const scanner = new Html5Qrcode("reader");
let lastResult = null;
let scanning = false;

function showMessage(msg, color="green") {
  const s = document.getElementById("status");
  s.style.color = color;
  s.textContent = msg;
}

// ابدأ المسح
Html5Qrcode.getCameras().then(devices => {
  if (devices && devices.length) {
    let cam = devices.find(c => c.label.toLowerCase().includes("back")) || devices[0];
    scanner.start(
      cam.id,
      { fps: 10, qrbox: 250 },
      qrCodeMessage => {
        console.log("✅ تم مسح الكود:", qrCodeMessage);

        // منع التكرار
        if (scanning) return;
        scanning = true;
        lastResult = qrCodeMessage;

        showMessage("✅ تم قراءة الكود بنجاح... جاري التسجيل");
        document.getElementById("student_id").value = qrCodeMessage;
        setTimeout(() => {
          document.getElementById("scanForm").submit();
        }, 800);
      },
      errorMessage => {
        // تجاهل الأخطاء البسيطة أثناء البحث
      }
    ).catch(err => {
      showMessage("❌ لم يتم تشغيل الكاميرا: " + err, "red");
    });
  } else {
    showMessage("🚫 لم يتم العثور على كاميرا متاحة", "red");
  }
}).catch(err => {
  showMessage("❌ خطأ في الوصول للكاميرا: " + err, "red");
});
</script>
{% endblock %}
