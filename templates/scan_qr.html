{% extends "layout.html" %}
{% block title %}Ù…Ø³Ø­ ÙƒÙˆØ¯ QR{% endblock %}
{% block content %}
<div class="text-center">
  <h3>ğŸ“· Ù…Ø³Ø­ ÙƒÙˆØ¯ QR</h3>
  <div id="reader" style="width:320px; margin:auto; border-radius:10px;"></div>

  <form id="scanForm" method="POST" action="{{ url_for('mark_attendance') }}">
    <input type="hidden" name="student_id" id="student_id">
    <input type="hidden" name="session_num" value="1">
  </form>

  <div id="status" class="mt-3 text-success fw-bold"></div>
</div>

<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script>
const scanner = new Html5Qrcode("reader");
let lastResult = null;
let scanning = false;

function showMessage(msg, color="green") {
  const s = document.getElementById("status");
  s.style.color = color;
  s.textContent = msg;
}

// Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø³Ø­
Html5Qrcode.getCameras().then(devices => {
  if (devices && devices.length) {
    let cam = devices.find(c => c.label.toLowerCase().includes("back")) || devices[0];
    scanner.start(
      cam.id,
      { fps: 10, qrbox: 250 },
      qrCodeMessage => {
        console.log("âœ… ØªÙ… Ù…Ø³Ø­ Ø§Ù„ÙƒÙˆØ¯:", qrCodeMessage);

        // Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±
        if (scanning) return;
        scanning = true;
        lastResult = qrCodeMessage;

        showMessage("âœ… ØªÙ… Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ÙƒÙˆØ¯ Ø¨Ù†Ø¬Ø§Ø­... Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„");
        document.getElementById("student_id").value = qrCodeMessage;
        setTimeout(() => {
          document.getElementById("scanForm").submit();
        }, 800);
      },
      errorMessage => {
        // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø¨Ø³ÙŠØ·Ø© Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¨Ø­Ø«
      }
    ).catch(err => {
      showMessage("âŒ Ù„Ù… ÙŠØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§: " + err, "red");
    });
  } else {
    showMessage("ğŸš« Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙƒØ§Ù…ÙŠØ±Ø§ Ù…ØªØ§Ø­Ø©", "red");
  }
}).catch(err => {
  showMessage("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§: " + err, "red");
});
</script>
{% endblock %}
